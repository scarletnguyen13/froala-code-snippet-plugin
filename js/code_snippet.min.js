(function ($) {
  $.FroalaEditor.PLUGINS.snippet = function (editor) {
    function apply () {
      var i;
      var blocks = editor.selection.blocks();
    
      if(editor.selection.text() != '' && $(editor.selection.element()).css('backgroundColor') == 'rgba(0, 0, 0, 0)') {
        var text='<br><pre><code>';
        for (i = 0; i < blocks.length; i++) {
          text+= blocks[i].innerHTML+'<br>';
        }
        text+='</code></pre><br>';
        text = editor.clean.html(text)
        editor.html.insert(text);
        editor.html.unwrap();
        editor.selection.restore();
        hljs.configure({useBR: true});
        $('pre code').each(function(i, block) {
          hljs.highlightBlock(block);
        });
      }
    }

    return {
      apply: apply
    }
  }

  $.FroalaEditor.DefineIcon('snippet', {NAME: 'code'});
  $.FroalaEditor.RegisterCommand('snippet', {
    title: 'Code Snippet',
    undo: true,
    focus: false,
    refreshAfterCallback: true,
    callback: function () {
      this.snippet.apply();
    }
  });
})(jQuery);